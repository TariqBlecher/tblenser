#Predictions for the observation
first results in but awaiting further testing
----------------------------------------
#Glafic comparison test:

see notebook in glafic_test/glafic_output

need to check whether the mass model in the input file reproduces the deflection map. using the writelens command.
data should be output in format (φ x , φ y , φ, κ, γ 1 , γ 2 , μ −1 ), checked the magnification maps..looks the same, although
the ones online are quite high resolution ~0.02 arcsec as opposed to what I was using ~0.2 arcsec


in /vault-tina/blecher/abell2744/glafic_test, there are two directories lens_dir and lens_dir_rdisklarge.the only difference is the size of the gaussian as per the following diff:

gauss_src = np.exp(-(r**2 / (2.0 * (hidisk.rdisk_arcsec/2)**2)))
---
gauss_src = np.exp(-(r**2 / (2.0 * (hidisk.rdisk_arcsec/4)**2)))


not working. takes too long to run to sort out bugs. going to just do fake sources near the center instead
 so I can cut down on comp time..but not sure if this will work.

on radiopadre now, need to test lens_parametric_srcs for correct ra/dec .

glafic: did a hack of lens_parametric srcs

defmap side of the test is done. Output parmtrack files which can then be input into glafic

[OF] cutout margin bug fixing. Cutout margins can cause serious trouble if margin extends beyond image boundary

---------------------------------------
#Basic internal testing

[OF] Minor bug for tiny, highly inclined sources where the small grids introduce interpolation errors.
 decreasing min grid size to 3.

[OF] fixed some bugs in redshift sampling

[OF] inclination problem is solved. everything looking good except that the magnifications are very low. Good magnification evolution with redshift.

Need to pad edges for interpolation - done

Magnification is still anti-correlating strongly with inclination. Trying with a 4x interpolated map. Taking substantially longer to run.

[OF]serious problems for very high HI mass m>11.3 . Fix does not seem to be working. magnification explodes. check fix - works

[OF] fixed with zoom but now I need an adjustable zoom based on the extent of the HI image
magnification seems correlated with inclination which suggests a sampling bug - fixed

[OF] rdisk solver crashes for very high mhi masses > 12

[OF]Next fix is that it is good to scipy.ndimage.zoom into the image a bit to smooth over the noise. Probably a better approach would be to just
zoom the full deflection map by 2. hmmm trying both and the image zoom seems to be doing better for some reason


[OF] I've got it! I have to rescale the flux by (pixscale_defmap/pixscale_hi)^2

[OF] Ok seems like the positions are fine now but the magnifications are often less than 1 which indicates that the pixel resolution of the image
is indeed too large..I suppose an easy way to check this is to set the deflection map to zero so there's no deflection then just look at the
magnifications in that case and it should just be 1. Good way to quantify errors.

[OF]HIDISC translation written in hdr. when calculating image onedgrid takes this into account to the calculated source grid
However it seems like some or all the images are zero...check this though

[OF] HIDisk is taking toooo long. npix of cats grid is too large. need to rather just interpolate onto it.
GOing back to the original hidisk, write to fits (try use astropy module), then calc image using the source fits.
This will be nice and accurate too.

[AC] Stellar mass uncertainties not properly done. using uniform sampling for now

[OF] corrected z sampling for being > cluster and < band end

[TP] just checked that all ASTRODEEP cut sources are within the cats map -> they are

[TP]two weeks ago I compared the magnifications from the deflection map vs magnifications from the magnification map.
I don't expect these to be exactly the same. They were not wildly different which was good
********************
Document shorthand
OF [old fix]
TP [test passed]
AC [astrodeep catalog related]

******************
Useful tests:

Set deflection map to zero. Check magnifications equal 1.
Magnification evolution with redshift